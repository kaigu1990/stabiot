test_that("derive_bor works as expected with default arguments", {
  adrs <- tibble::tribble(
    ~USUBJID, ~TRTSDTC,     ~ADTC,        ~AVALC,
    "1",      "2020-01-01", "2020-01-01", "PR",
    "1",      "2020-01-01", "2020-02-01", "CR",
    "1",      "2020-01-01", "2020-02-16", "NE",
    "1",      "2020-01-01", "2020-03-01", "CR",
    "1",      "2020-01-01", "2020-04-01", "SD",
    "2",      "2019-12-12", "2020-01-01", "SD",
    "2",      "2019-12-12", "2020-02-01", "PR",
    "2",      "2019-12-12", "2020-03-01", "SD",
    "2",      "2019-12-12", "2020-03-13", "CR",
    "4",      "2019-12-30", "2020-01-01", "PR",
    "4",      "2019-12-30", "2020-03-01", "NE",
    "4",      "2019-12-30", "2020-04-01", "NE",
    "4",      "2019-12-30", "2020-05-01", "PR",
    "5",      "2020-01-01", "2020-01-01", "PR",
    "5",      "2020-01-01", "2020-01-10", "PR",
    "5",      "2020-01-01", "2020-01-20", "PR",
    "6",      "2020-02-02", "2020-02-06", "PR",
    "6",      "2020-02-02", "2020-02-16", "CR",
    "6",      "2020-02-02", "2020-03-30", "PR",
    "7",      "2020-02-02", "2020-02-06", "PR",
    "7",      "2020-02-02", "2020-02-16", "CR",
    "7",      "2020-02-02", "2020-04-01", "NE",
    "8",      "2020-02-01", "2020-02-16", "PD"
  ) %>%
    mutate(
      ADT = ymd(ADTC),
      TRTSDT = ymd(TRTSDTC),
      PARAMCD = "OVR",
      PARAM = "Overall Response by Investigator"
    ) %>%
    select(-TRTSDTC)

  res <- derive_bor(data = adrs)
  expect_tibble(res)
  expect_identical(
    res,
    tibble::tibble(
      USUBJID = as.character(c(1:2, 4:8)),
      ADTC = c("2020-02-01", "2020-03-13", "2020-01-01", "2020-01-01",
               "2020-02-16", "2020-02-16", "2020-02-16"),
      AVALC = c("CR", "CR", "PR", "PR", "CR", "CR", "PD"),
      ADT = ymd(ADTC),
      TRTSDT = ymd(c("2020-01-01", "2019-12-12", "2019-12-30", "2020-01-01",
                     "2020-02-02", "2020-02-02", "2020-02-01")),
      PARAMCD = rep("BOR", 7),
      PARAM = rep("Best Overall Response", 7),
      AVAL = c(1, 1, 2, 2, 1, 1, 4)
    )
  )
})

test_that("derive_bor works as expected for confirmed BOR", {
  adrs <- tibble::tribble(
    ~USUBJID, ~TRTSDTC,     ~ADTC,        ~AVALC,
    "1",      "2020-01-01", "2020-01-01", "PR",
    "1",      "2020-01-01", "2020-02-01", "CR",
    "1",      "2020-01-01", "2020-02-16", "NE",
    "1",      "2020-01-01", "2020-03-01", "CR",
    "1",      "2020-01-01", "2020-04-01", "SD",
    "2",      "2019-12-12", "2020-01-01", "SD",
    "2",      "2019-12-12", "2020-02-01", "PR",
    "2",      "2019-12-12", "2020-03-01", "SD",
    "2",      "2019-12-12", "2020-03-13", "CR",
    "4",      "2019-12-30", "2020-01-01", "PR",
    "4",      "2019-12-30", "2020-03-01", "NE",
    "4",      "2019-12-30", "2020-04-01", "NE",
    "4",      "2019-12-30", "2020-05-01", "PR",
    "5",      "2020-01-01", "2020-01-01", "PR",
    "5",      "2020-01-01", "2020-01-10", "PR",
    "5",      "2020-01-01", "2020-01-20", "PR",
    "6",      "2020-02-02", "2020-02-06", "PR",
    "6",      "2020-02-02", "2020-02-16", "CR",
    "6",      "2020-02-02", "2020-03-30", "PR",
    "7",      "2020-02-02", "2020-02-06", "PR",
    "7",      "2020-02-02", "2020-02-16", "CR",
    "7",      "2020-02-02", "2020-04-01", "NE",
    "8",      "2020-02-01", "2020-02-16", "PD"
  ) %>%
    mutate(
      ADT = ymd(ADTC),
      TRTSDT = ymd(TRTSDTC),
      PARAMCD = "OVR",
      PARAM = "Overall Response by Investigator"
    ) %>%
    select(-TRTSDTC)

  res <- derive_bor(data = adrs, confirm = TRUE)
  expect_identical(
    res,
    tibble::tibble(
      USUBJID = as.character(c(1:2, 4:8)),
      ADTC = c("2020-02-01", "2020-02-01", "2020-05-01", "2020-01-01",
               "2020-02-06", "2020-02-06", "2020-02-16"),
      AVALC = c("CR", "SD", "SD", "NE", "PR", "NE", "PD"),
      ADT = ymd(ADTC),
      TRTSDT = ymd(c("2020-01-01", "2019-12-12", "2019-12-30", "2020-01-01",
                     "2020-02-02", "2020-02-02", "2020-02-01")),
      PARAMCD = rep("CBOR", 7),
      PARAM = rep("Confirmed Best Overall Response", 7),
      AVAL = c(1, 3, 3, 5, 2, 5, 4)
    )
  )
})

test_that("derive_bor works as expected with zero NE", {
  adrs <- tibble::tribble(
    ~USUBJID, ~TRTSDTC,     ~ADTC,        ~AVALC,
    "1",      "2020-01-01", "2020-01-01", "PR",
    "1",      "2020-01-01", "2020-02-01", "CR",
    "1",      "2020-01-01", "2020-02-16", "NE",
    "1",      "2020-01-01", "2020-03-01", "CR",
    "1",      "2020-01-01", "2020-04-01", "SD",
    "2",      "2019-12-12", "2020-01-01", "SD",
    "2",      "2019-12-12", "2020-02-01", "PR",
    "2",      "2019-12-12", "2020-03-01", "SD",
    "2",      "2019-12-12", "2020-03-13", "CR",
    "4",      "2019-12-30", "2020-01-01", "PR",
    "4",      "2019-12-30", "2020-03-01", "NE",
    "4",      "2019-12-30", "2020-04-01", "NE",
    "4",      "2019-12-30", "2020-05-01", "PR",
    "5",      "2020-01-01", "2020-01-01", "PR",
    "5",      "2020-01-01", "2020-01-10", "PR",
    "5",      "2020-01-01", "2020-01-20", "PR",
    "6",      "2020-02-02", "2020-02-06", "PR",
    "6",      "2020-02-02", "2020-02-16", "CR",
    "6",      "2020-02-02", "2020-03-30", "PR",
    "7",      "2020-02-02", "2020-02-06", "PR",
    "7",      "2020-02-02", "2020-02-16", "CR",
    "7",      "2020-02-02", "2020-04-01", "NE",
    "8",      "2020-02-01", "2020-02-16", "PD"
  ) %>%
    mutate(
      ADT = ymd(ADTC),
      TRTSDT = ymd(TRTSDTC),
      PARAMCD = "OVR",
      PARAM = "Overall Response by Investigator"
    ) %>%
    select(-TRTSDTC)

  res <- derive_bor(data = adrs, max_ne = 0, confirm = TRUE)
  expect_identical(
    res,
    tibble::tibble(
      USUBJID = as.character(c(1:2, 4:8)),
      ADTC = c("2020-01-01", "2020-02-01", "2020-05-01", "2020-01-01",
               "2020-02-06", "2020-02-06", "2020-02-16"),
      AVALC = c("PR", "SD", "SD", "NE", "PR", "NE", "PD"),
      ADT = ymd(ADTC),
      TRTSDT = ymd(c("2020-01-01", "2019-12-12", "2019-12-30", "2020-01-01",
                     "2020-02-02", "2020-02-02", "2020-02-01")),
      PARAMCD = rep("CBOR", 7),
      PARAM = rep("Confirmed Best Overall Response", 7),
      AVAL = c(2, 3, 3, 5, 2, 5, 4)
    )
  )
})

test_that("derive_bor works as expected with at least 56 days of reference interval
          and 56 days after start treatment", {
  adrs <- tibble::tribble(
    ~USUBJID, ~TRTSDTC,     ~ADTC,        ~AVALC,
    "1",      "2020-01-01", "2020-01-01", "PR",
    "1",      "2020-01-01", "2020-02-01", "CR",
    "1",      "2020-01-01", "2020-02-16", "NE",
    "1",      "2020-01-01", "2020-03-01", "CR",
    "1",      "2020-01-01", "2020-04-01", "SD",
    "2",      "2019-12-12", "2020-01-01", "SD",
    "2",      "2019-12-12", "2020-02-01", "PR",
    "2",      "2019-12-12", "2020-03-01", "SD",
    "2",      "2019-12-12", "2020-03-13", "CR",
    "4",      "2019-12-30", "2020-01-01", "PR",
    "4",      "2019-12-30", "2020-03-01", "NE",
    "4",      "2019-12-30", "2020-04-01", "NE",
    "4",      "2019-12-30", "2020-05-01", "PR",
    "5",      "2020-01-01", "2020-01-01", "PR",
    "5",      "2020-01-01", "2020-01-10", "PR",
    "5",      "2020-01-01", "2020-01-20", "PR",
    "6",      "2020-02-02", "2020-02-06", "PR",
    "6",      "2020-02-02", "2020-02-16", "CR",
    "6",      "2020-02-02", "2020-03-30", "PR",
    "7",      "2020-02-02", "2020-02-06", "PR",
    "7",      "2020-02-02", "2020-02-16", "CR",
    "7",      "2020-02-02", "2020-04-01", "NE",
    "8",      "2020-02-01", "2020-02-16", "PD"
  ) %>%
    mutate(
      ADT = ymd(ADTC),
      TRTSDT = ymd(TRTSDTC),
      PARAMCD = "OVR",
      PARAM = "Overall Response by Investigator"
    ) %>%
    select(-TRTSDTC)

  res <- derive_bor(data = adrs, ref_start_window = 56, ref_interval = 56, confirm = TRUE)
  expect_identical(
    res,
    tibble::tibble(
      USUBJID = as.character(c(1:2, 4:8)),
      ADTC = c("2020-01-01", "2020-03-01", "2020-05-01", "2020-01-01",
               "2020-03-30", "2020-02-06", "2020-02-16"),
      AVALC = c("PR", "SD", "SD", "NE", "SD", "NE", "PD"),
      ADT = ymd(ADTC),
      TRTSDT = ymd(c("2020-01-01", "2019-12-12", "2019-12-30", "2020-01-01",
                     "2020-02-02", "2020-02-02", "2020-02-01")),
      PARAMCD = rep("CBOR", 7),
      PARAM = rep("Confirmed Best Overall Response", 7),
      AVAL = c(2, 3, 3, 5, 3, 5, 4)
    )
  )
})
